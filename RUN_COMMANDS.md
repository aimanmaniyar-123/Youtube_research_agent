#!/bin/bash

# YouTube Research Agent - Complete Run Commands
echo "ğŸ¥ YouTube Research Agent - Complete Setup & Run Commands"
echo "=========================================================="

# Step 1: Environment Setup
echo ""
echo "ğŸ“‹ STEP 1: Environment Setup"
echo "----------------------------"

# Create project directory
echo "ğŸ“ Creating project directory..."
mkdir -p youtube_research_agent
cd youtube_research_agent

# Setup environment file
echo "âš™ï¸ Setting up environment..."
if [ ! -f .env ]; then
    cp .env.example .env
    echo "âœ… Created .env file - PLEASE EDIT WITH YOUR API KEYS!"
    echo "   Required: YOUTUBE_API_KEY and OPENAI_API_KEY"
else
    echo "âœ… .env file already exists"
fi

echo ""
echo "ğŸ“‹ STEP 2: Docker Setup (Recommended)"
echo "------------------------------------"
echo "ğŸ”§ Option A: Full Docker Setup"
echo "   docker-compose up --build -d"
echo ""
echo "â³ Wait for services to start (30-60 seconds)..."
echo ""
echo "ğŸ” Check services:"
echo "   â€¢ API: curl http://localhost:8000/health"
echo "   â€¢ Flower: curl http://localhost:5555"

echo ""
echo "ğŸ“‹ STEP 3: Local Development Setup"
echo "--------------------------------"
echo "ğŸ Option B: Local Python Setup"
echo ""
echo "# Create virtual environment"
echo "python -m venv venv"
echo ""
echo "# Activate virtual environment"
echo "# On Linux/Mac:"
echo "source venv/bin/activate"
echo "# On Windows:"
echo "venv\\Scripts\\activate"
echo ""
echo "# Install base dependencies"
echo "pip install -r requirements.txt"
echo ""
echo "# Install Streamlit dependencies"
echo "pip install streamlit==1.28.0 plotly==5.17.0 pandas==2.1.3 altair==5.1.2"
echo ""
echo "# Start individual services"
echo "docker-compose up -d db redis qdrant  # Infrastructure only"

echo ""
echo "ğŸ“‹ STEP 4: Running the Application"
echo "--------------------------------"

echo ""
echo "ğŸ–¥ï¸ Terminal 1 - FastAPI Backend:"
echo "uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
echo ""
echo "ğŸ”„ Terminal 2 - Celery Worker:"
echo "celery -A celery_app.celery_app worker --loglevel=info --concurrency=4"
echo "ğŸ¨ Terminal 5 - Streamlit Dashboard:"
echo "streamlit run streamlit_app.py --server.port 8501"

echo ""
echo "ğŸ“‹ STEP 5: Quick Test Commands"
echo "----------------------------"

echo ""
echo "ğŸ” Health Check:"
echo "curl http://localhost:8000/health"
echo ""
echo "ğŸ¯ Start Research (Example):"
echo 'curl -X POST "http://localhost:8000/api/v1/research/start" \'
echo '  -H "Content-Type: application/json" \'
echo '  -d '"'"'{'
echo '    "channel_identifier": "@channelname",'
echo '    "scope": "standard",'
echo '    "max_videos": 50,'
echo '    "include_transcripts": true'
echo '  }'"'"
echo ""
echo "ğŸ“Š Check Task Status:"
echo "curl http://localhost:8000/api/v1/research/{task_id}"
echo ""
echo "ğŸ“„ Get Results:"
echo "curl http://localhost:8000/api/v1/research/{task_id}/result"

echo ""
echo "ğŸ“‹ STEP 6: Access Points"
echo "----------------------"

echo ""
echo "ğŸŒ Web Interfaces:"
echo "   â€¢ Streamlit Dashboard: http://localhost:8501"
echo "   â€¢ FastAPI Docs: http://localhost:8000/docs"
echo "   â€¢ Celery Flower: http://localhost:5555"
echo "   â€¢ Qdrant Console: http://localhost:6333/dashboard"
echo ""
echo "ğŸ”Œ Direct API Access:"
echo "   â€¢ Health: http://localhost:8000/health"
echo "   â€¢ Research: POST http://localhost:8000/api/v1/research/start"
echo "   â€¢ Monitor: GET http://localhost:8000/api/v1/research/{task_id}"
echo ""
echo "ğŸ“Š Database Connections:"
echo "   â€¢ PostgreSQL: localhost:5432 (postgres/password)"
echo "   â€¢ Redis: localhost:6379"
echo "   â€¢ Qdrant: localhost:6333"

echo ""
echo "ğŸ“‹ STEP 7: Production Deployment"
echo "-------------------------------"

echo ""
echo "ğŸ³ Docker Production:"
echo "# Build and deploy all services"
echo "docker-compose -f docker-compose.yml up -d --build"
echo ""
echo "# Scale workers for high load"
echo "docker-compose up -d --scale celery-worker=4"
echo ""
echo "# Monitor logs"
echo "docker-compose logs -f"

echo ""
echo "ğŸ“‹ STEP 8: Troubleshooting"
echo "-------------------------"

echo ""
echo "âŒ Common Issues & Solutions:"
echo ""
echo "1. API Connection Failed:"
echo "   â€¢ Check if FastAPI is running: curl http://localhost:8000/health"
echo "   â€¢ Verify .env file has correct API keys"
echo "   â€¢ Check Docker services: docker-compose ps"
echo ""
echo "2. Tasks Not Processing:"
echo "   â€¢ Check Celery workers: celery -A celery_app.celery_app status"
echo "   â€¢ Monitor with Flower: http://localhost:5555"
echo "   â€¢ Check Redis connection: redis-cli ping"
echo ""
echo "3. Database Connection Issues:"
echo "   â€¢ Verify PostgreSQL: docker-compose logs db"
echo "   â€¢ Check connection string in .env"
echo "   â€¢ Run migrations: python -c \"from config.database import create_tables; create_tables()\""
echo ""
echo "4. YouTube API Quota Exceeded:"
echo "   â€¢ Check quota usage in logs"
echo "   â€¢ Wait for daily reset (midnight PT)"
echo "   â€¢ Consider upgrading API quota"
echo ""
echo "5. Streamlit Not Loading:"
echo "   â€¢ Check if FastAPI backend is running"
echo "   â€¢ Verify port 8501 is available"
echo "   â€¢ Check browser console for errors"

echo ""
echo "ğŸ“‹ DEVELOPMENT WORKFLOW"
echo "====================="

echo ""
echo "ğŸ”„ Typical Development Session:"
echo "1. Start infrastructure: docker-compose up -d db redis qdrant"
echo "2. Activate venv: source venv/bin/activate"
echo "3. Start FastAPI: uvicorn main:app --reload"
echo "4. Start Celery: celery -A celery_app.celery_app worker --loglevel=info"
echo "5. Start Streamlit: streamlit run streamlit_app.py"
echo "6. Open browser: http://localhost:8501"

echo ""
echo "ğŸ§ª Testing:"
echo "pytest test_system.py -v"
echo "pytest tests/ -v --cov=. --cov-report=html"

echo ""
echo "ğŸ“ Logs Location:"
echo "   â€¢ Application logs: ./logs/"
echo "   â€¢ Docker logs: docker-compose logs [service]"
echo "   â€¢ Celery logs: Check Flower dashboard"

echo ""
echo "ğŸ¯ READY TO USE!"
echo "==============="
echo ""
echo "Your YouTube Research Agent is ready! ğŸš€"
echo ""
echo "Quick Start:"
echo "1. Edit .env with your API keys"
echo "2. Run: docker-compose up -d --build"
echo "3. Run: streamlit run streamlit_app.py"
echo "4. Visit: http://localhost:8501"
echo ""
echo "Happy researching! ğŸ¥ğŸ“Š"